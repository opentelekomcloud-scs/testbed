---
- secret:
    name: SECRET_TESTBED
    data:
      MANAGERLESS_CREDENTIALS: !encrypted/pkcs1-oaep
        - JAsfBM5A9Tie4ihJ91nBfLE+YQ6QUSgPUqi75HgWUA1+CcLfJRmH7hI06+fpj+nL8DmRE
          OrAQ4zVo9UX3C9Nsx8V1aRGiV0JVp8kQeTl+JX1YnH1jDRrWMUyjijhIU0606xHFC/mqK
          BwaapDolbJ9qf/KyZf95p4D83Asm6p9Fs+Bxe39GPbow98tu0zCMDjgY3ZHwCvL2atReL
          iVLREvR/hfcGZlOgmhOSV9cqglIW3VDdvIS3OXRSezGKiRP7mNpIM5CNfwOMN9ptriWLL
          jIlKMSt+lO+5CchZUXTU4Ka6Lc+65JLirzJxmTCefkomVyFjrg07V9GQAXHW8Z81TjCHA
          0wZVxPdouZU1k89pCwsrO51u+Ti8KtkJgsBBeOiTQoBhUH7W3tldxk0tf0u5dS6tfbfKt
          9AjVTacbLGqJMXNOgEQn2Zgl5/IcSGWY3mTlTKfOBv0TK5l8ATmmMtuHpFTkcq+lt1hxY
          4ODmMkP9waTb46OaI4aMVwfwWQQnlfRRMKbxH1lQONNyomH2OVEeUkaFx8u13Dx3bNkIc
          v67ut7/VSN7YMSPwz/vntpRxhEkx+A2SnKueDHvyn5J+3RLYnT1KeKZ5CWkPjGsqdgo3K
          jn0ELHJsqUvP+NHiz3cdi32vnBl/o8Fu9u5SwvRJV97Nj/6eXlRAqckAj9kTMg=
      PUBLICCLOUDS: !encrypted/pkcs1-oaep
        - xUNLeryZnS7WOQpNQyko0M9zIBcGR5q62AsKprNXGhuGhZn4g4booqH9Xo6ilrVUBvs6A
          lNfRtAoBycTAwVwsjkB0q1YBhhVVkt2ZH6MMB6MLTsId+gyR1+YDJyJwXCeO4eG9uSX/I
          Ac1HRy6YrTlFtnt4b6nLWpcGdqj5uI1vgnn0PZOrlwOqQ25QTGO5jqIoOMtupdPJNQWmX
          mZI6uug2NbtSQg+ye/Ak0g5NxFFOWAxJkQHtWwBub26w0S8jbjNUGfymtsgU61FSSWlI4
          NaZgnJcwFyFFl0r/wH7wyc17aXZhG9pF0EltzIC15FSN7L4gVdefMP0H4rVSuMFa/h05Q
          wZvweNWEico2DdAtW1qqdLKT0Ozj0pSPNyH+AiSaALOGjwYV32S82dtOoBlEl8rAoRxJg
          1Q2yoaU4hUebbLwfgRZRJOQTe9V41aMrJwO79Huf/YZdF7O146FHRtMjSu8titWFf4RyO
          eTGycbiNOCblOA5zPdoHdzDcZbwq6qpkoe17Zlya0wNn1Sw2s8KhkYeRgFoEsj6sJ3usR
          0sAcVGVjthqwIJyqp3pkph7WA+Z7eKN4JzO9uv8w7pb6BAKAqf3vVGlO6IeFUQ2tu4GLN
          m1K44JWu1x0LqCwFDdVV6IL93V2vJQ+GFbXBNMMAezeVkMFwdz+BPN072miT1M=

- semaphore:
    name: semaphore-testbed-managerless
    max: 1

- semaphore:
    name: semaphore-testbed
    max: 1

- job:
    name: testbed-deploy-managerless
    nodeset: ubuntu-jammy
    pre-run: playbooks/managerless/pre.yml
    run: playbooks/managerless/deploy.yml
    post-run: playbooks/managerless/post.yml
    cleanup-run: playbooks/managerless/cleanup.yml
    required-projects:
      - osism/terraform-base
    timeout: 10800
    vars:
      terraform_blueprint: testbed-managerless
      cloud_env: managerless-otc
    secrets:
      - name: secret
        secret: SECRET_TESTBED
    semaphores:
      - name: semaphore-testbed-managerless

- job:
    name: testbed-deploy
    nodeset: ubuntu-jammy
    pre-run: playbooks/pre.yml
    run: playbooks/deploy.yml
    post-run: playbooks/post.yml
    cleanup-run: playbooks/cleanup.yml
    required-projects:
      - osism/terraform-base
    timeout: 10800
    vars:
      terraform_blueprint: testbed-default
      cloud_env: managerless-otc
    secrets:
      - name: secret
        secret: SECRET_TESTBED
    semaphores:
      - name: semaphore-testbed

- job:
    name: testbed-deploy-post
    nodeset: ubuntu-jammy
    pre-run: playbooks/pre.yml
    run: playbooks/deploy.yml
    post-run: playbooks/post.yml
    cleanup-run: playbooks/cleanup.yml
    required-projects:
      - osism/terraform-base
    timeout: 10800
    vars:
      terraform_blueprint: testbed-default
      cloud_env: managerless-otc
    secrets:
      - name: secret
        secret: SECRET_TESTBED
    semaphores:
      - name: semaphore-testbed

- project:
    merge-mode: squash-merge
    check:
      jobs:
        - flake8
    check-post:
      jobs:
        - testbed-deploy
    post:
      jobs:
        - testbed-deploy-post
    periodic-hourly-otc:
      jobs:
        # - ansible-lint
        - flake8
#        - testbed-deploy-managerless
#        - python-black
#        - yamllint
